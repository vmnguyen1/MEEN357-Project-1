import numpy as np
import math
from scipy.interpolate import interp1d

#define constants

#r = 0.30    #m #wheel radius
#wm = 1.0    #kg #wheel mass
#t_s = 170   #Nm #motor stall torque
#t_nl = 0    #Nm #motor no-load torque
#w_nl = 3.80 #rad/s #motor no-load speed
#mm = 5.9    #kg #motor mass
#spm = 75    #kg #science payload mass
#rtgm = 90   #kg #RTG mass (power subsystem)
#cm = 659    #kg #chassis mass (mass of rover structure)
#d1 = 0.04   #m #speed reducer pinion diameter 
#d2 = 0.07   #m #speed reducer gear diameter 
#srm = 1.5   #kg #speed reducer mass 
#gmars = 3.72#m/s^2 #acceleration due to gravity 


rover = {'wheel_assembly':{'wheel':{'radius': 0.30 , 'mass': 1.0},
                           'speed_reducer':{'type': 'reverted' , 'diam_pinion': 0.04 , 'diam_gear': 0.07 , 'mass': 1.5}, 
                           'motor':{'torque_stall': 170 , 'torque_noload': 0 , 'speed_noload': 3.80 , 'mass': 5.0}}, 
         'chassis':{'mass': 659}, 
         'science_payload':{'mass': 75}, 
         'power_subsys':{'mass': 90}}
wheel_assembly = {'wheel':{'radius': 0.30 , 'mass': 1.0},
                  'speed_reducer':{'type': 'reverted' , 'diam_pinion': 0.04 , 'diam_gear': 0.07 , 'mass': 1.5}, 
                  'motor':{'torque_stall': 170 , 'torque_noload': 0 , 'speed_noload': 3.80 , 'mass': 5.0}}
speed_reducer = {'type': 'reverted' , 'diam_pinion': 0.04 , 'diam_gear': 0.07 , 'mass': 1.5}
motor = {'torque_stall': 170 , 'torque_noload': 0 , 'speed_noload': 3.80 , 'mass': 5.9}
planet = {'g': 3.72}

experiment = {'time_range' : np.array([0,20000]),
              'initial_conditions' : np.array([0.3125,0]),
              'alpha_dist' : np.array([0, 100, 200, 300, 400, 500, 600, 700, 800, 900, 1000]),
              'alpha_deg' : np.array([11.509, 2.032, 7.182, 2.478, 5.511, 10.981, 5.601, -0.184,0.714, 4.151, 4.042]),
              'Crr' : 0.1}



# Below are default values for example only:
end_event = {'max_distance' : 50,
             'max_time' : 5000,
             'min_velocity' : 0.01}


def get_mass(rover):
    if type(rover) != dict:
        raise Exception("rover is not a dictionary")
    else:
        m = 6*rover['wheel_assembly']['wheel']['mass']+ 6*rover['wheel_assembly']['speed_reducer']['mass']+ 6*rover['wheel_assembly']['motor']['mass']+ rover['chassis']['mass']+ rover['science_payload']['mass']+ rover['power_subsys']['mass']
        return m
    

def get_gear_ratio(speed_reducer):
    if type(speed_reducer) != dict:
        raise Exception("rover is not a dictionary")
    if rover['wheel_assembly']['speed_reducer']['type'] != 'reverted' :
        print('''Error: 'type' field is not "reverted"''')
    else:
        Ng = (rover['wheel_assembly']['speed_reducer']['diam_gear'] / rover['wheel_assembly']['speed_reducer']['diam_pinion'])**2
        return Ng



def tau_dcmotor(omega, motor):
    if type(omega) == np.ndarray or type(omega) == float or type(omega) == int:
        if type(motor) == dict:
            tau = (motor['torque_stall'] - ((motor['torque_stall'] - motor['torque_noload']) / motor['speed_noload'])*omega)
        else: 
            raise Exception("motor is not a dictionary")
    else:
        raise Exception("omega is not a scalar or vector")
    return tau


def F_drive(omega, rover):
    tau = tau_dcmotor(omega, motor)
    if type(omega) != np.ndarray:
        raise Exception("omega is not a scalar or vector")
    if type(rover) != dict:
        raise Exception("rover is not a dictionary")
    else:
        Ng = get_gear_ratio(speed_reducer)
        Fd = []
        for i in tau:
            Fd.append(6*i*Ng/ rover['wheel_assembly']['wheel']['radius'])
        return Fd

    

def F_gravity(terrain_angle, rover, planet):
    if type(terrain_angle) != np.ndarray:
        raise Exception("terrain_angle is not a scalar or vector")
    for i in terrain_angle:
        if i < -75:
            raise Exception("terrain angle is less than -75 degrees")
        if i > 75:
            raise Exception("terrain angle is more than -75 degrees")
    if type(rover) != dict:
        raise Exception("rover is not a dictionary")
    if type(planet) !=dict:
        raise Exception("planet is not a dictionary")
    else:
        m = get_mass(rover)
        gmars = planet['g']
        Fgt = []
        for i in terrain_angle:
            Fgt_point = m*gmars*math.sin(i)
            Fgt_point = -Fgt_point
            Fgt.append(Fgt_point)
        return Fgt
    

def F_rolling(omega, terrain_angle, rover, planet, Crr):
    m = get_mass(rover)
    Ng = get_gear_ratio(speed_reducer)
    if type(omega) != np.ndarray:
        raise Exception("omega is not a scalar or vector")
    if type(terrain_angle) != np.ndarray:
        raise Exception("terrain_angle is not a scalar or vector")
    for i in terrain_angle:
        if i < -75:
            raise Exception("terrain angle is less than -75 degrees")
        if i > 75:
            raise Exception("terrain angle is more than -75 degrees")
    if type(rover) != dict:
        raise Exception("rover is not a dictionary")
    if type(planet) !=dict:
        raise Exception("planet is not a dictionary")
    else:
        gmars = planet['g']
        V_rover = []
        for i in range(len(omega)):
            V_rover.append(rover['wheel_assembly']['wheel']['radius']*(omega[i]) / Ng)
        Fn = []
        for i in terrain_angle:
            Fn_point = m*gmars*math.cos(i)
            Fn.append(Fn_point)
        Frrsimple = []
        for i in Fn:
            Frrsimple.append(Crr*i)
        Frr = []
        for i in range(len(Frrsimple)):
            Frr.append(-1*(math.erf(40*V_rover[i])*Frrsimple[i]))
        return Frr


def F_net(omega, terrain_angle, rover, planet, Crr):
    Fd = F_drive(omega, rover)
    Fgt = F_gravity(terrain_angle, rover, planet)
    Frr = F_rolling(omega, terrain_angle, rover, planet, Crr)
    if type(omega) != np.ndarray:
        raise Exception("omega is not a scalar or vector")
    if type(terrain_angle) != np.ndarray:
        raise Exception("terrain_angle is not a scalar or vector")
    for i in terrain_angle:
        if i < -75 :
            raise Exception("terrain angle is less than -75 degrees")
        if i > 75 :
            raise Exception("terrain angle is more than -75 degrees")
    if type(rover) != dict:
        raise Exception("rover is not a dictionary")
    if type(planet) !=dict:
        raise Exception("planet is not a dictionary")
    else:
        F = []
        for i in range(len(Fd)):
            x = Fd[i] + Frr[i] + Fgt[i]
            F.append(x)
        return F
    
v = 5 

def motorW(v, rover):
    if type(v) == np.ndarray or type(v) == int or type(v) == float:
        if type(rover) == dict:
            w_in = v/wheel_assembly['wheel']['radius']
            Ng = get_gear_ratio(speed_reducer)
            w_out = w_in/Ng
            
        else:
            raise Exception("rover must be a dictionary")
        
    else: 
        raise Exception("v must be scalar or vector")
    return w_out

t=1
y=np.arange(1,1)
alpha_fun = interp1d(experiment['alpha_dist'],experiment['alpha_deg'], kind = 'cubic', fill_value='extrapolate')

def rover_dynamics(t, y, rover, planet, experiment):
    if type(t) == int or type(t) == float:
        if type(y) == np.ndarray:
            if type(rover) == dict:
                if type(planet) == dict:
                    if type(experiment) == dict:
                        m = get_mass(rover)
                        F = F_net(omega, terrain_angle, rover, planet, Crr)
                        terrain_angle = alpha_fun(y[1])

                    else:
                        raise Exception("experiment must be a dictionary")
                else:
                    raise Exception("planet must be a dictionary")
            else:
                raise Exception("rover must be a dictionary")
        else:
            raise Exception("y must be a 1D numpy array")
    else: 
        raise Exception("t must be a scalar")
        
        
def mechpower(v, rover):
    if type(v) == np.ndarray or type(v) == int or type(v) == float:
        if type(rover) == dict:
            tau = tau_dcmotor(omega, motor)
            w_out = motorW(v, rover)
            P = tau * w_out
        else:
            raise Exception("rover must be a dictionary")
        
    else: 
        raise Exception("v must be scalar or vector")
    return P    
    
    
omega = 1
terrain_angle_deg = np.linspace(-10,35,10)
terrain_angle =  np.linspace(-10,35,10) * (math.pi)/180

Crr = -0.2
Crr = abs(Crr)

m = get_mass(rover)
Ng = get_gear_ratio(speed_reducer)
tau = tau_dcmotor(omega, motor)
#Fd = F_drive(omega, rover)
#Fgt = F_gravity(terrain_angle, rover, planet)
#F_rr = F_rolling(omega, terrain_angle, rover, planet, Crr) 
#F = F_net(omega, terrain_angle, rover, planet, Crr)

w_out = motorW(v, rover)
print(w_out, 'rad/s')

P = mechpower(v, rover)
print(P, 'Watts')


